
- Linux是一个多用户, 多任务的分时操作系统
- 一台Linux主机可以**同时**登录**多名**用户
- Linux使用**用户权限**机制对系统管理

# 用户

**用户权限机制**
- 主要功能: 提供不同用户使用系统的**权限分配**
- 目的: 保证用户数据与文件的**安全**
- 账号实质: 是用户在系统上的标识, 系统依据账户区分每个用户的文件, 进程, 任务, 给每个用户提供特定的工作环境

#### 特点
- 每个用户拥有一个**UserID**, 操作系统实际读取的是UID
- 每个用户只属于**一个主组**, 同时还可以属于**一个或多个附属组**, 一个用户最多有31个附属组
- 每个组拥有一个**GroupID**
- 每个进程以一个**用户身份**进行, 该用户对此进程拥有**资源控制权限**
- 每个可登录用户拥有一个指定的**Shell环境**

#### 分类
- 超级用户root(UID=0)
	- 每个系统有且只有一个
	- 拥有最高权限, 可以删除终结任何程序
- 系统用户(UID<1000/500)
	- 与系统运行和**系统提供服务**密切相关的用户
	- 通常在安装相关软件包时**自动创建**并保持默认状态
	- 系统用户不能用于登录
- 普通用户(UID >= 1000/500)
	- 由超级用户创建
	- 完成**指定权限的操作**, 且只能操作自己拥有权限的文件和目录

#### 配置文件
- `/etc/passwd` : 保存用户信息
	- 对所有用户可读
	- 格式: `username:password:uid:gid:userinfo:home:shell`
	- 冒号分隔不同信息
	- 记录了每一个用户的基本属性
		- 用户名: 系统唯一, 由字母数字符号组成
		- 口令: 用x代替, 存储在/etc/shadow中
		- UID: 唯一标识用户
		- GID: 表示用户所属组
		- 用户相关信息: 用户全名等
		- home: 登录系统进入的目录
		- shell : 第一次登录的shell环境
	- 一行对应一个用户
- `/etc/shadow` : 保存用户密码(加密形式)
	- 只有root可读
	- 格式: `username:password:lastchg:min:max:warn:inactive:expire:flag`
	- 用户名: 用户登录系统使用的名字, 唯一
	- 口令: MD5加密后的密码
	- lastchg: 1970年1月1到最近一次修改密码经过的天数
	- min: 密码有效的最小天数, 密码在多少天内不能再次修改
	- max : 密码在多少天后必须被修改
	- warn: 密码到期前多少天给用户发出警告
	- inactive : 账号失效日, 账号从1970年1月1后多少天失效
	- expire & flag : 保留域
- `/etc/group` : 保存组信息
- `/etc/skel` : 用户模板文件目录
	- `.bash_profile` 或 `.profile` : 每次登陆时执行, 用于定义初始化变量
	- `.bashrc` : 每次开启新终端时执行, 定义永久的别名
	- `.bash_logout` : 每次注销后执行
- `/etc/login.defs` : 用户属性限制, 密码过期时间, 密码最大长度等限制
- `/etc/default/useradd` : 显示或更改默认的useradd配置文件
	- 定义了新建用户的一些默认属性

# 用户管理

#### 添加useradd
用于添加用户
**格式** : `useradd [选项] 用户名`
**选项**
- **-d** : 用户**登陆时的目录**
- -c : 备注文字
- -e : 账号的有效期
- -f : 密码过期时指定天数后关闭该账号
- **-g** : 指定用户**所属组**
- **-G** : 指定用户**所属附加组**
- **-m** : **自动建立**用户的登入目录
- -r : 创建系统账号
- -s : 指定用户的登录shell
- -u : 指定用户的用户ID, 如果添加-o, 则用户ID可以和其他用户重复
	- 不建议使用-o使uid重复

**执行过程**
1. 读取`/etc/default/useradd`文件, 获取新建用户默认属性, 执行创建操作
2. 在`/etc/passwd`中添加用户信息
3. 如果使用passwd命令创建密码, 密码被加密保存在/etc/shadow中
4. 为新建用户创建家目录 : /home/username
5. 将`/etc/skel`中.bash开头的文件复制到家目录中
6. 创建与用户名相同的username组, 如果没有指定所属组, 那么默认属于username通冥族
7. username组信息保存在`/etc/group`中

- 新建的用户需要**创建家目录, 指定shell, 设置好密码后才能登录**

#### 密码passwd
用于设置用户的认证信息, 包括密码, 密码有效期等, 格式如下
`passwd [选项] 用户名`
**选项**
- -l : 锁定密码, 锁定后密码失效, 用户无法登录(新用户默认锁定)
- -d : 删除密码(仅管理员可用)
- -S : 列出密码相关信息(仅管理员可用)
- -f : 强制执行

**说明**
- root可以**随意修改密码**, 即使警告也可以成功保存
- 普通用户设置时尽量复杂
- 修改当前登录账户的密码时, 可以**缺省用户名**
- 密码保存在`/etc/shadow`中

#### 删除userdel
删除执行账户以及**与其相关的文件和信息**
`userdel [选项] 用户名`
- -f : 强制删除, 即使该用户为当前账户
- -r : 删除用户同时删除与该用户相关的所有文件

#### 修改usermod
修改用户账号信息, 即账号的属性, 如用户ID, 主目录, 用户组, 登录shell等
格式: `usermod 选项 用户名`
**选项**
- -c : 修改备注
- **-d** : 修改**登录目录**
- -e : 修改有效期限
- -f : 修改缓冲天数, 即密码过期到关闭账号的时间
- **-g** : 修改**所属组**
- **-l** : 修改**账号名称**
- -L : 锁定密码, 使密码失效
- **-s** : **修改shell**
- **-u** : 修改**用户id**
- -U : 解除密码锁定

#### 有效期chage
修改账号和密码的有效期限
**格式** : `chage 用户名 [选项]`
**选项**
- -m : 密码可更改的最小天数, 0表示任意时候
- -M : 保持有效最大天数
- -W : 到期前提前预警的天数
- -E : 账号到期的日期, -1表示永不过期, 0表示马上过期
- -d : 修改上次更改的日期
- -i : 停滞时期, 如果密码过期这些天, 那么此账号将不可用
- -l : 列出当前的设置, 非特权用户确认账号密码何时过期

# ACL机制
Access Control List , 针对单一用户或组设置特定的权限

**相关命令**
- setfacl : 设置文件的ACL
	- **chmod**根据**文件所有者**, **所属群组**及**其他用户**三级权限进行权限分配
	- **setfacl**可以**针对每一文件或目录**进行更加精确的权限分配
- getfacl : 获取文件的ACL
- chacl : 更改文件或目录的ACL
	- 与chmod相似, 但是**更加强大精细**
	- chmod可以控制文件被**何人调用**, 但是某一用户的文件如果只想**给特定的用户看**时, 则需要chacl完成需求.

#### setfacl
**格式** : `setfacl 选项 文件名`
**功能** : 设定用户或群组对指定文件的访问
**选项**
- **-m** : **修改**指定文件的acl (不能和-x混合使用)
	- 使用方式 : `setfacl -m u:用户名:权限 文件名`
	- u -> 用户名
	- g -> 组名
- **-x** : **删除**后续参数
	- 对某个用户或某个组使用
- -b : 删除所有acl设定参数
- -k : 移除预设的acl参数
- -R : 递归设置acl参数
- -d : 预设目录的acl参数

#### getfacl
格式: `getfacl 选项 文件名`
功能: 查看文件或目录当前设定的ACL权限信息
选项:
- -a : 仅显示文件访问控制列表
- -d : 仅显示默认访问控制列表
- -c : 不显示注释表头
- -e : 显示所有的有效权限
- -E : 显示无效权限
- -s : 跳过只有基条目的文件

#### chacl
格式 : `chacl [选项] 文件`
功能 : 更改文件或目录当前设定的ACL权限信息
**选项**
- -b : 同时修改文件权限和默认目录权限
- -d : 设置目录默认权限
- -R : 只删除文件的权限
- -D : 只删除目录的权限
- -B : 删除所有权限
- -l : 列出所有文件和目录权限
- -r : 设置所有目录及其子目录下的权限

# 用户组
- 组是具有**相同特性**的**用户集合**
- 设置目的: 便于权限的**统一组织和分配**
- 注意: 组账号不能登录计算机

#### 特点
- 每个组一个组ID
- 组信息保存在/etc/group中
- 每个用户至少一个主组, 同时还可以拥有最多31个附属组
- 用户与组是多对多关系, 一个用户可以同时属于多个组
- 组账户分为
	- 超级组, GID = 0
	- 系统组, GID ∈ `[1,999]`
	- 用户组, GID ≥ 1000

#### 配置文件

**组账号文件**
- `/etc/group`
- 组名 : 组的名称, 由数字字母符号组成
- 组口令 : 默认不使用, 需要使用需要特殊设置
- 组ID : GID, 识别不同组的唯一标识
- 组内用户列表: 属于该组的所有用户名表, 用 `,` 间隔

**组影子文件**
- `/etc/gshadow`
- 组名, 组口令, 组管理员, 组内用户列表
- **组成** : `group_name:group_password:group_id:group:members`
	- 组名
	- 口令 : 加密过的密码, 如果显示为 ! , 表示该组没有密码
	- 组ID
	- 组成员信息 : 属于该组的用户清单, 逗号分隔

#### 添加组groupadd
默认情况下新建用户的用户组与用户名相同, 在创建用户同时被创建
主动添加用户组使用groupadd
**格式** : `groupadd [选项] 用户名`
**选项**
- **-g** : 指定新建用户组的**组id**
- -r : 创建系统用户组
- -o : 允许创建组ID已存在的用户组

#### 删除组groupdel
**格式** : `groupdel 参数`

#### 修改组groupmod
**格式** : `groupmod [选项] [用户组]`
**选项**
- -g : 指定用户组的**组id
- -n : 修改用户组的**组名**
- -o : 允许修改组ID已存在的用户组

#### 组切换newgrp
- 如果创建用户时没有指定用户组, 系统会自动创建一个同名用户组, 这个组就是**主组**
- 除主组外, 用户所在的其他组都是**附加组**, 为用户指定附加组可以使其拥有对应的权限
- **格式** : `newgrp [用户组]`

#### 用户切换

**su : 切换用户**
使用su可以在任意用户之间切换
需要输入密码
**格式** : `su [选项] username`
- **-c** : 执行完对应指令后**切换回原来用户**
- -l : 切换用户同时切换到对应工作目录, 环境变量随之改变
- -m , -p : 切换用户不改变环境变量
- **-s** : **指定执行的shell**

**sudo : 以管理员权限运行**
格式: `sudo [选项] -u 用户 [命令]`
**选项**
- -b : 后台执行
- -h : 显示帮助
- -H : HOME环境变量设置为新身份的HOME环境变量
- -k : 结束密码的有效期限
- -l : 列出目前用户可执行与无法执行命令
- -p : 改变询问密码提示符
- -s : 指定shell
- -u : 指定用户执行, 默认为root
**说明**
1. 可以将sudo看作**受限的su**, 使得部分用户可以以其他用户身份执行命令
2. 使用sudo之前, 要配置`/etc/sudoers`, 为当前用户配置权限
3. 使用root打开/etc/sudoers进行修改
4. `/etc/sudoers`文件中一条配置信息设置了root用户可能在任何情况下执行任何命令
	- root ALL=(ALL) ALL
	- **格式** : `用户名 主机名=(切换的用户名) 可以执行的权限命令`
	- **要求** : 权限命令路径需要是绝对路径








# 配置文件格式

### 配置文件

- SpringBoot提供了**多种属性配置方式**, 以下是不同配置下改为80端口示例; 注意, boot中所有配置文件名都应该为application, 以便boot进行检测
- 可以在Project Structure中的Facets中, 设置项目所用的配置文件

**application.properties**
```properties
server.port=80
```

**application.yaml & application.yml**
- yaml和yml是同一种格式
- yaml格式中, 数据前面和冒号之间**必须间隔**一个空格
```yaml
server:  
  port: 80
```

### 注意事项
- 以后使用时, 主要使用 `yml` 格式的配置文件
- 当三个格式的配置文件都存在时
	- properties > yml > yaml
- SpringBoot内置属性过多, 且所有属性集中在一起修改, 使用时, 通过**提示词+关键字**修改属性
	- 以logging.level为例, 直接输入level, 即可得到一串提示, 自行选择即可
```yaml
logging:  
  level:  
    root: debug
```
- 解释: 日志级别为debug, 即将所有的debug信息都打印出来
	- 改为warn, 即将所有的warn信息都打印出来
	- 默认级别为info

# yaml

### 简介

- YAML(YAML Ain't Markup Language), 是一种数据序列化格式
- 优点
	- 易于阅读
	- 容易与脚本语言互动
	- 以**数据为核心**, 重数据, 轻格式
- YAML文件扩展名
	- `.yml` : 主流
	- `.yaml`

### 语法规则

- 大小写敏感
- 属性层级关系使用多行结束, 每行结尾用冒号结束
- 使用缩进表示层级关系, 同层级左侧对齐, **只允许使用空格**, 不允许使用tab
- 属性值**前面添加空格**, 属性名与属性值之间使用 `冒号+空格` 分隔
- ` # ` 表示注释

**数组格式**
- 数组数据在数据书写位置的下方使用减号作为数据开始符号, 每行书写一个数据, 减号与数据间使用空格分隔
```yaml
enterprise:
  name: majinliang
  age: 18
  likes:
    - basketball
    - game
    - reading
```

### 数据读取方式

##### 单个读取
- 读取时, 只需要使用 `@Value(${变量名})` 注解, 即可将配置中的值注入到代码中
- 对于多级结构的变量 , 可以使用 `${一级属性名.二级属性名...}` 的形式. 如 `server.port` 的方式来表示多级结构
- 对于数组, 按照类似C语言读取数组的方式进行, 如 `enterprise.subject[0]`
```java
@Value("${lesson}")  
private String lesson;
@Value("${server.port}")  
private Integer port;
@Value("${enterprise.subject[0]}")  
private String subject_00;
```

##### 通过环境变量读取
- 通过自动装配Environment对象, 即可把所有的环境配置信息全部装配到该对象中
- 通过该对象的 `getProperty(属性名)` , 即可获得对应属性的值
```java
@Autowired  
private Environment environment;  
@GetMapping("/{id}")  
public String getById(@PathVariable Integer id) { 
    System.out.println(environment.getProperty("lesson"));  
    System.out.println(environment.getProperty("server.port"));  
    System.out
        .println(environment.getProperty("enterprise.subject[1]"));  
    return "hello SpringBoot!";  
}
```

##### 通过pojo对象加载
- 使用 ` @Component ` 将pojo类定义为一个bean
- 使用 ` @ConfigurationProperties(profix = {填写名称}) ` , 设置该对象从配置中哪个部分读取数据
	- 对于profix部分, 也可以书写 `profix = {一级属性名.二级属性名...}`
- 想要使用相关配置时, 在代码中定义相关bean对象, 并使用自动装配注入属性
```java
@Component  
@ConfigurationProperties(prefix = "enterprise")  
public class Enterprise {
    ...
}
@Autowired  
private Enterprise enterprise;
```
- 以后可能在配置中配置若干信息, 比如Mybatis配置信息等, 然后由对应的依赖通过pojo对象形式加载配置文件内的信息
- 所以yaml中的配置必须按照规定的形式进行书写

**自定义对象封装数据警告解决方案**
- 在自己的pom.xml中加入如下依赖, 即可解决idea警告
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-configuration-processor</artifactId>
    <optional>true</optional>
</dependency>
```

# 多环境启动

### 环境编写

- 在yml配置文件中, 可以使用三个横线(`---`)来标志上下两个配置属于不同的环境
- 可以通过使用`spring.profiles: {名称}`来标记不同的环境
- 在配置文件顶部, 可以使用 `spring.profiles.active: {环境名}` 来指定当前要使用的环境
- <span style="color: red">注意: 主流springboot版本(2.4 之后)已经不允许这种写法</span>

- **正确写法**是通过 `spring.config.activate.on-profile: {名称}` 来标记环境
```yaml
spring:
  profiles:
    active: dev
---
spring:
  config:
    activate:
      on-profile: dev
server:
  port: 80
---
(略)
---
(略)
```

**properties类型配置文件的多环境**
- 虽然不常用, 但是properties的多环境配置如下所示, 使用**多文件**方式进行区分
1. 在application.properties中使用`spring.profiles.active={环境名}`来指定要运行的环境
2. 创建多个properties文件, 格式为 `application-{环境名}.properties` , 如`application-dev.properties` , 每个文件即代表一种不同的环境

### 启动命令格式

- 可以使用命令启动jar包来切换程序运行过程中使用的环境
- 使用指令 `java -jar {报名} --spring.profiles.active={环境名}` 来指定运行所在的环境
- 同理, 也可以用这种方式修改配置中的其他内容, 比如运行所在的端口等
- 由此可见, 命令行参数的优先级比配置文件中的优先级更高
- 参数优先级详情参见 https://docs.spring.io/spring-boot/reference/features/external-config.html#features.external-config

**注意**
- 建议对无用的配置文件进行备份, 并使其不再生效
- 打包前注意最好先执行一下clean, 以免上次的结果干扰本次运行
- 如果配置文件中存在中文, 请在`Editor->File Encoding`中, 修改编码方式为utf-8

### 兼容性问题

- 对于多环境开发, 如果maven中的设置和springboot中的设置起冲突, 则maven的优先级更高, 因为springboot的打包等依赖于maven
- 可以在springboot的配置文件中配置环境名称, 然后再maven的pom.xml中设置相应的环境, 并在对应的`properties`中使用`profile.active`标签进行设置
```xml
<profiles>
    <profile>
        <id>dev</id>
        <properties>
            <profile.active>dev</profile.active>
        </properties>
        <activation>
            <activeByDefault>true</activeByDefault>
        </activation>
    </profile>
</profiles>
```

- 为了可以在yaml中检测到maven中的配置, 要在maven中加入插件`maven-resources-plugin`, 并在其中配置`useDefaultDelimiters`为true来开启在yaml中使用maven配置
- 同时建议设置字符集 `encoding` 为 `utf-8`
```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-resources-plugin</artifactId>
            <version>3.2.0</version>
            <configuration>
                <encoding>UTF-</encoding>
                <useDefaultDelimiters>true</useDefaultDelimiters>
            </configuration>
        </plugin>
    </plugins>
</build>
```
对应的yaml中应该配置为
```yaml
spring:
  profiles:
    active: ${profile.active}
```

# 配置文件分类

- 之前交由测试时, 可以在命令行中设置临时配置来解决SpringBoot在测试等的配置问题, 然而, 临时配置过多时, 同样会引起管理的繁琐化

**配置文件分级**
- SpringBoot中4级配置文件, 优先级由高到低
	- 1级: file : config/application.yml => jar文件同级目录下config文件夹内的yaml
	- 2级: file : application.yml => jar文件同级目录下的yaml
	- 3级: classpath: config/application.yml => 项目resources文件夹内config文件夹内的yaml
	- 4级: classpath: application.yml => 项目resources文件夹内的yaml
- 作用
	- 1级和2级用作**系统打包上线后**根据业务需求设置通用属性
	- 3级和4级用于**系统开发阶段**设置通用属性

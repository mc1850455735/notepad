
# 简介

- 事物是一组操作的集合, 他是一个**不可分割的**工作单位
- 事务会把所有的操作**作为一个整体**一起向系统提交或撤销操作请求
- 这些操作要么同时成功, 要么同时失败
- 默认MySQL的事务是自动提交的, 也就是说, 当执行一条DML语句, MySQL会**立即**隐式的提交事务
- 想要使用事务, 必须手动开启事务, 手动提交, 手动设置事务的回滚
![[数据库/MySQL/Inbox/Pasted image 20250820220743.png]]

# 事物操作

**设置事务**
- 查看 / 设置事务提交方式
	- `SELECT @@autocommit;` => 查看事务提交方式
	- `SET @@autocommit = 0;` => 设置为手动提交操作
- 开启事务
	- `START TRANSACTION` 或 `BEGIN;`
- 提交事务 => `COMMIT;`
- 回滚事务 => `ROLLBACK;`

**注意**
- 一旦设置完成事务提交后, 当整段代码运行成功后, 使用commit提交事务
- 当存在错误时, 使用rollback回滚整个事务

**示例**
- 示例01 : 使用 `SET @@autocommit` 将当前对话设置为手动提交
- 使用 `SET @@autocommit` 设置后, 当前整个对话都将一直处于必须手动提交的状态
```mysql
set @@autocommit = 0;  
update account set money = money - 1000 where name = '张三';  
update account set money = money + 1000 where name = '李四';  
commit;
```
- 示例02 : 使用 `START TRANSACTION` 手动开启事务
- 当当前事务执行完毕后 (即调用commit或rollback), 当前事务将结束. 也就是使用 `START TRANSACTION` 开启的事务是临时性的
```mysql
start transaction;  
update account set money = money - 1000 where name = '张三';  
update account set money = money + 1000 where name = '李四';  
commit;  
rollback;
```


# 四大特性ACID

- 原子性 - Atomicity
	- **事务**是不可分割的**最小操作单元**, 要么全部成功, 要么全部失败
- 一致性 - Consistency
	- 事务完成时 , 必须使所有的数据都**保持一致状态**
- 隔离性 - Isolation
	- 数据库系统提供的隔离机制 , 保证事务在不受外部并发操作影响的**独立环境**下运行
- 持久性 - Durability
	- 事务一旦提交或回滚 , 它对数据库中的数据的**改变就是永久**的


# 并发事务问题

**脏读**
- 一个事务读到另外一个事务还没有提交的数据
- 只要确保当前事务一定要读取commit后的数据, 就可以解决这个问题
**不可重复读**
- 一个事务先后读取**同一条记录** , 但两次读取的数据不同 , 称之为不可重复读
- 只要对单行加锁, 就可以确保在当前事务中, 该行数据只能被自己修改
**幻读**
- 一个事务按照条件查询数据时 , 没有对应的数据行, 但是在插入数据时, 又发现这行数据已经存在, 好像出现了'幻影'
- 

**注意**
- 不可重复读针对一条数据的修改操作, 而幻读针对一批数据的添加, 删除
- 不可重复读通过对单行加锁来解决, 而幻读通过对一个范围加锁来解决, 所以解决了幻读就一定能解决不可重复读


# 事务隔离级别

- 从上到下隔离级别越来越高, 数据越来越安全, 性能越来越低
- MySQL默认事务隔离级别 : Repeatable Read
- Oracle默认事务隔离级别 : Read uncommitted
![[Pasted image 20221219174010.png]]

**InnoDB隔离级别实现详解**
- Repeatable Read : 
	- 为实现可重复读, InnoDB会在事务中创建一个snapshot数据库, 读取时从数据库中读取, 这即实现了重复读, 同时也阻止了幻读现象中的**读幻读**
	- 但是在进行insert, update, delete等操作时, InnoDB为保证数据一致性, 会选择从current数据库中读取, 从而出现了 查询不到相应条目, 但是无法对其插入等现象
- Serializable : 
	- 串行化, 要求事务的执行必须是线性的, 从而彻底避免的并发导致的一致性问题

**实现**
- 查看事务隔离级别
```sql
SELECT @@TRANSACTION_ISOLATION;
```

- 设置事务隔离级别
- SESSION : 当前对话窗口有效
- GLOBAL : 全局会话窗口有效
```sql
SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL 
{READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE}
```

**示例**
- 示例01: 修改当前会话隔离级别为read uncommitted
```sql
set session transaction isolation level read uncommitted;
```





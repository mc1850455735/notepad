# Linux MySQL

- 在日常学习, 工作环境等时, 绝大部分情况下使用的是Linux环境下的MySQL
- 所以为模拟真实企业开发中环境, 建议使用Linux下的MySQL
- 具体安装过程自行解决
- 默认root只能在localhost访问, 如果想要远程访问, 还需要创建一个root账户用于远程访问, 并为其分配权限
```mysql
create user 'root'@'%' identified with mysql_native_password by `root`;
grant all on *.* to 'root'@'%';
```
- 降低MySQL密码等级要求
```mysql
SET GLOBAL validate_password.check_user_name = 'OFF';
SET GLOBAL validate_password.length = 1;
SET GLOBAL validate_password.policy = 0;
SET GLOBAL validate_password.number_count = 0;
SET GLOBAL validate_password.special_char_count = 0;
SET GLOBAL validate_password.mixed_case_count = 0;
```

# 概述

**概念**
- 索引(index)是帮助MySQL**高效获取数据**的 **数据结构**(有序) .
- 在数据之外, 数据库管理系统还维护着满足特定查找算法的数据结构, 这些数据结构以某种方式指向数据, 这样就可以在这些数据结构上实现高级查找算法, 这些数据结构就是 **索引**

**作用**
- 在没有索引时, 数据库会从头到尾依次检测表中字段的每个值, 使用顺序查找, 即全表扫描
- 在有索引时, 以二叉树为例, 数据库会**维护**一个二叉搜索树, 查找的过程就是使用二叉搜索树的过程, 相对效率更高
- 通常情况下, 存储引擎使用的索引数据结构都是一个B+树

**优缺点**
- 优点
	- 提高数据检索效率, 降低数据库IO成本
	- 通过索引列对数据排序, 降低了数据排序成本, 减少CPU消耗
- 缺点
	- 索引列会占用磁盘空间
	- 索引大大提升查询表效率的同时, 也降低了更新表的效率, 如insert, update, delete等


# 索引结构

### 类型

- MySQL索引在存储引擎层实现, 不同的存储引擎有不同的索引结构
- B+Tree : 可用于范围查询, 目前主流存储引擎的索引都使用B+Tree的结构
	- 相较于二叉树, B+树层级更少, 效率更高
	- 相较于B树, B+树节点不存储数据, 固定大小的页, 一个页可以存储更多的索引, 在相同数据量的情况下, B+树相较B树层级更少; 同时, B+树所有数据都在叶子节点中, 查询效率更稳定
	- 相较于hash, B+树支持范围匹配和排序操作
- Hash索引 : 查询效率最高, 但是只能用于精确查询, 不支持范围查询
![[数据库/MySQL/Inbox/Pasted image 20250821181613.png]]

**支持情况**
- 默认一般情况, 索引都是指B+Tree索引
- MySQL中, 支持hash索引的是Memory引擎, 但是InnoDB中具有**自适应hash**功能, hash索引是InnoDB存储引擎根据B+树索引在指定条件下**自动构建**的
![[数据库/MySQL/Inbox/Pasted image 20250821181955.png]]

### BTree和B+Tree

**传统二叉树**
- 二叉树缺点 : 顺序插入时, 会退化称为链表, 查询性能大大降低
- 红黑树缺点 : 大数据量情况下, 层级较深, 检索较慢

**B树** (多路平衡二叉树)
- 具体插入, 删除, 分裂过程略
![[数据库/MySQL/Inbox/Pasted image 20250821182537.png]]

**B+树**
- 所有的数据都在叶子节点, 所有的非叶子节点只起到索引的作用
- 叶子节点形成一个单向链表
![[数据库/MySQL/Inbox/Pasted image 20250821195526.png]]
- MySQL索引数据结构对经典的B+Tree进行了优化, 在原有B+Tree的基础上, 增加一个指向相邻叶子节点的链表指针, 形成了带有顺序指针的B+Tree, 提高了区间访问的性能
![[数据库/MySQL/Inbox/Pasted image 20250821200415.png]]

### Hash

**结构**
- 哈希索引就是采用一定的hash算法, 将键值换算成新的Hash值, 映射到对应的槽位上, 然后存储在hash表中
- 发生Hash碰撞时, 使用拉链法Hash解决
![[数据库/MySQL/Inbox/Pasted image 20250821200926.png]]

**特点**
- 只能用于等值匹配, 不支持范围查询
- 无法利用索引完成排序操作
- 查询效率高, 大多数情况下只需要一次检索, 效率通常高于B+树


#  索引分类

### 索引种类分类

- 主键索引 (`PRIMARY`) : 针对表中主键创建的索引, **默认自动创建**, 只能有一个
- 唯一索引 (`UNIQUE`) : 避免同表中某数据列中值重复, 可以有多个
	- 当在某字段添加唯一约束时, 会自动为字段添加唯一索引
- 常规索引 : 快速定位特定数据, 可以有多个
- 全文索引 (`FULLTEXT`) : 查找文本中的关键词, 可以有多个

### InnoDB索引分类

- 聚集索引(Clustered Index) : 
	- 将数据存储和索引放在一块, 索引结构的叶子节点保存了**行数据**
	- 必须有, 而且只有一个
	- 默认主键索引就是聚集索引
- 二级索引(Secondary Index)
	- 将数据和索引分开存储, 索引结构的叶子节点关联的是**对应的主键**
	- 可以存在多个

**聚集索引选取规则**
- 如果存在主键, 主键索引就是聚集索引
- 如果不存在主键, 则将使用第一个UNIQUE索引作为聚集索引
- 如果既不存在主键, 也不存在任何唯一索引, InnoDB将自动生成一个rowid作为隐藏的聚集索引

**二级索引查询流程 (回表查询)**
- 通过B+树, 查询欲查询字段在B+树叶子节点中的位置
- 通过叶子节点中的id, 回到聚集索引的B+树中
- 在聚集索引B+树中, 根据拿到的id进行查询
- 定位到对应叶子节点, 该节点中行数据即为欲查询行
- 这个查询过程被称为 **回表查询**

# 索引语法

##### 创建索引
- **索引参数**
	- unique : 唯一索引
	- fulltext : 全文索引
	- 不加选项 : 常规索引
- **列名参数**
	- 一个索引可以关联多个字段
	- 如果一个索引只关联一个字段, 这种索引称为**单列索引**
	- 如果一个索引关联多个字段, 这种索引称为**联合索引**或**组合索引**
- **结构**
```mysql
create [unique|fulltext] index index_name 
on table_name(index_col_name, ...);
```

##### 查看索引
- 查看指定表中所有的索引
```mysql
show index from table_name;
```

##### 删除索引
- 删除指定表中的索引
```mysql
drop index index_name on table_name;
```

##### 示例

- 示例01 : 为name字段添加索引, 允许该字段重复
- 常见索引名规则: `idx_表名_列名`
```mysql
create index idx_user_name on tb_user(name);
```

- 示例02 : 为phone添加索引, 该字段非空且唯一, 创建唯一索引
```mysql
create unique index idx_user_phone on tb_user(phone);
```

- 示例03 : 为profession, age, status创建联合索引
- 联合索引顺序是有讲究的, 创建语句的属性会影响Seq_in_index
```mysql
create index idx_user_pro_age_sta 
on tb_user(profession, age, status);
```

- 示例04 : 为email建立合适的索引提升查询效率
```mysql
create index idx_user_email on tb_user(email);
```

# SQL性能分析

### SQL执行频次

- MySQL客户端连接成功后, 可以通过`show [session|global] status`命令查询服务器状态信息
- 通过如下指令, 可以查看当前数据库的Insert, Update, Delete, Select访问频次 (共计7个下划线)
```mysql
show global status like 'Com_______';
```

### 慢查询日志

- 慢查询日志是记录了所有执行时间超过指定参数(long_query_time, 单位秒, 默认10s)的所有SQL预计的日志
- 通过指令 `show variables like 'slow_query_log'`可以看到数据库慢查询相关配置
- 慢查询日志默认不开启, 需要在MySQL配置文件 (/etc/my.cnf) 中配置如下:
	- slow_query_log = 1 : 开启慢查询日志
	- long_query_time = 2 : 设置慢查询超时时间为2秒
```config
slow_query_log = 1
long_query_time = 2
```











# MySQL体系结构

- 连接层
	- 连接层位于最上层, 主要用来接收客户端的连接
	- 用于完成连接处理, 授权认证, 权限检测, 相关安全方案等操作
- 服务层
	- 服务层完成大多数的核心服务功能，如SQL接口, 查询解析器, 查询优化器, 查询缓存等
	- 所有**跨存储引擎**的实现也都位于服务层，如DML, DDL, 存储过程, 视图, 触发器等。
- 存储引擎层 (可插拔式)
	- MySQL中提供了多种存储引擎供选择, 同时如果不能满足需求, 还可以手动进行扩展, 故称为可插拔式
	- 存储引擎控制MySQL中的数据存储和提取的方式, 服务器通过API和存储引擎进行通信和交互
	- **索引** (Index) 是在存储引擎层实现的。不同的存储引擎具有不同的索引结构
	- InnoDB引擎为MySQL5.5版本后的默认存储引擎
- 存储层
	- 主要是将数据存储在磁盘文件系统中，并完成与存储引擎的交互
	- 其中包含 日志, 数据, 索引, 二进制值, 错误信息 等信息

![[数据库/MySQL/Inbox/Pasted image 20250821112918.png]]


# 存储引擎简介

- 存储引擎是存储数据、建立索引、更新或查询数据等技术的实现方式
	- 不同的引擎有不同的应用场景, 没有好坏之分
- 存储引擎是**基于表**的，而不是基于库的，所以存储引擎也可以被称为**表类型**
	- 也就是说, 一个数据库下的多张表可以选用**不同的**存储引擎
- MySQL默认存储引擎为 InnoDB
	- **设置存储引擎** : `ENGINE = INNODB`

**建表时参数**
- `ENGINE` - 存储引擎类型
- `AUTO_INCREMENT` - 自增数据下一条的值
- `DEFALULT CHARSET` - 默认字符集
- `COLLATE` - 排序方式
- `COMMIT` - 注释信息

**查看支持的存储引擎**
```mysql
show engines;
```

**示例**
- 示例01 : 创建my_myisam表, 指定MyISAM引擎
```mysql
create table my_myisam(  
    id int,  
    name varchar(10)  
)engine = MyISAM;
```
- 示例02 : 创建表时指定Memory引擎
```mysql
create table my_memory(  
    id int,  
    name varchar(10)  
)engine = Memory;
```


# 存储引擎特点

### InnoDB

- **介绍**：一种兼具**高可靠性**和**高性能**的存储引擎，在MySQL5.5以后，InnoDB是默认的MySQL引擎。
- **特点**：
	- DML操作遵循ACID模型，支持**事务**
	- **行级锁**，提高并发访问性能
	- 支持**外键约束**，保证数据完整性和正确性
- **磁盘文件**：
	- xxx.ibd : 每一个使用innodb的表都会对应一个ibd格式文件, 该文件被称为**表空间文件**
	- 该文件中存储该表的表结构（frm，sdi）、数据和索引
	- 早期innodb表结构存储在frm文件中, 在8.0后, 表结构转而存储在sdi文件中, 而sdi文件融入ibd表空间文件

**表文件参数**
- 是否每个表对应单独一个表空间文件 参数 (MySQL8.0默认打开)：`innodb_file_per_table`
- 通过如下指令, 可以查看当前数据库系统的参数
```mysql
show variables like 'innodb_file_per_table';
```

**InnoDB逻辑存储结构**
- 在InnoDB中，分为 TableSpace, Segment, Extent, Page, Row, Page五种等级
- 中文名称分别为表空间, 段, 区, 页, 行, 具体等级组成关系如下图所示
- 其中, Page是磁盘操作的最小单元, 其中包含
	- Trx id : 最后一次操作的id
	- Roll pointer : 指针
	- col : 各个字段
- 区和页大小是固定的, 一个区大小为1M，一个页大小为16K
![[Pasted image 20230605142049.png]]


### MyISAM

- **介绍** : MyISAM是MySQL早期默认存储引擎
- **特点** : 
	- 不支持事务和外键
	- 支持表锁，不支持行锁
	- 访问速度快
- **文件：**
	- MYD - 表中数据
	- MYI - 存储索引
	- sdi - 表结构信息 : 以json形式存储

### Memory

- **介绍：** 
	- Memory引擎的表数据是存储在内存中的
	- 由于受到硬件问题、或断电影响，表中数据将会丢失
	- 只能作为临时表或缓存使用
- **特点：** 
	- 内存存放，访问速度较快
	- 默认使用hash索引
- **文件：** 
	- sdi - 存储表结构信息

### 区别

**InnoDB与MyISAM区别**
- InnoDB支持事务
- InnoDB支持行锁, MyISAM只支持表锁
- InnoDB支持外键

![[Pasted image 20230605143840.png]]

# 存储引擎的选择

选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂系统, 还可以根据实际情况选择多种引擎混合使用。

- InnoDB：MySQL默认引擎，支持事务、外键、行级锁。如果应用对事务完整性和并发条件下数据的一致性要求较高，且除插入和查询外, 更新、删除操作较多，则应该使用InnoDB（绝大多数）
- MyISAM：如果应用以**读取和插入为主**，只有很少的更新和删除且对于事物完整性和并发性要求不高，则使用MyISAM（一般是非核心数据, 如日志）
- Memory：将所有数据保存在内存中，访问速度快，通常用于临时表以及缓存。Memory的缺陷是表的大小有限制，太大的表无法缓存在内存中，且无法保障数据的安全性

- 需要使用 MyISAM 和 Memory 的场景通常有其他更好用的noSql数据库
	- 替代 MyISAM - MongoDB
	- 替代 Memory - Redis

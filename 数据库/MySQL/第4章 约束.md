# 概述

1. 概念 - 约束是作用于表中字段上的规则, 用于限制存储在表中的数据
2. 目的 - 保证数据库中数据的正确, 有效性和完整性
3. 注意 - 约束作用于表中字段,  可以在创建表/修改表的时候添加约束
4. 分类
![[Pasted image 20221218235346.png]]

# 约束演示

![[数据库/MySQL/Inbox/Pasted image 20250818130015.png]]
- 实现上表
- id - 主键, 且自动增长
	- `id INT PRIMARY KEY auto_increment COMMENT '主键'`
- name - 不为空且唯一
	- `name VARCHAR(10) NOT NULL UNIQUE COMMENT '姓名'`
- age - 大于0且小于120
	- `age int CHECK(age > 0 AND age <= 120) COMMENT '年龄'`
- status - 默认为1
	- `status CHAR(1) DEFAULT '1' COMMENT '状态'`
- gender - 无约束
	- `gender CHAR(1) COMMENT '性别'`
```mysql
CREATE TABLE `user` (
	id INT PRIMARY KEY auto_increment COMMENT '主键',
	`name` VARCHAR(10) NOT NULL UNIQUE COMMENT '姓名',
	age int CHECK(age > 0 AND age <= 120) COMMENT '年龄',
	`status` CHAR(1) DEFAULT '1' COMMENT '状态',
	gender CHAR(1) COMMENT '性别'
) COMMENT '用户表';
```

**约束演示**
- 主键id自增
```mysql
INSERT INTO `user`(`name`, age, `status`, gender) 
VALUES('Tom1', 19, '1', '男'),('Tom2', 25, '0', '男');
INSERT INTO `user`(`name`, age, `status`, gender) 
VALUES('Tom3', 19, '1', '男');
```
- name不重复, 不为空
	- 当试图插入的记录中的字段出现重复时, MySQL会先给该记录分配id, 然后发现该记录中字段出现重复, 随后拒绝插入
	- 但是由于id已经分配了, 所以会导致表中id不连续
```mysql
INSERT INTO `user`(`name`, `age`, `status`, `gender`)  
VALUES(NULL, 19, '1', '男');
INSERT INTO `user`(`name`, `age`, `status`, `gender`) 
VALUES('Tom3', 19, '1', '男');
```
- age由check约束限制了范围
```mysql
INSERT INTO `user`(`name`, age, `status`, gender)  
VALUES('Tom4', 80, '1', '男');  -- 允许
INSERT INTO `user`(`name`, age, `status`, gender)  
VALUES('Tom5', 180, '1', '男'); -- 不允许
INSERT INTO `user`(`name`, age, `status`, gender)  
VALUES('Tom6', -1, '1', '男'); -- 不允许
```
- status会由于default约束提供默认值
```mysql
INSERT INTO `user`(`name`, age, gender)  
VALUES('Tom8', 18, '男');
```

# 外键约束

- 概念: 用来让两张表之间建立连接从而保证数据的**一致性和完整性**
- 具有外键的表是**子表** , 外键所关联的表是**父表**
- 如下图, 员工表为子表, 部门表为父表
![[数据库/MySQL/Inbox/Pasted image 20250818132926.png]]

### 添加外键约束
- 外键约束要加在子表上

##### 创建表时添加外键约束
```mysql
CREATE TABLE 表名(
	字段名 数据类型;
	...
	[CONSTRAINT] [外键名称] FOREIGN KEY (外键字段名) 主表(主表列名);
)
```

##### 对已存在的表添加外键约束
```MYSQL
ALTER TABLE 表名 ADD CONSTRAINT 外键名称 FOREIGN KEY (外键字段名) REFERENCES 主表(主表列名);
```
- 示例
- `ALTER TABLE emp ADD CONSTRAINT fk_emp_dept_id FOREIGN KEY (dept_id) REFERENCES dept(id);`

### 删除外键约束

```MYSQL
ALTER TABLE 表名 DROP CONSTRAINT 外键名称;
```
- 示例
- `ALTER TABLE emp DROP CONSTRAINT fk_emp_dept_id;`

### 删除 / 更新行为

```mysql
ALTER TABLE 表名 ADD CONSTRAINT 外键名称 FOREIGN KEY (外键字段) REFERENCES 主表名 (主表字段名) ON UPDATE 行为 ON DELETE 行为;
```

**MySQL外键约束行为**
- **`NO ACTION`** (默认)
	- 当在父表中删除/更新对应记录时, 首先检查该记录是否有对应外键, 如果有则**不允许**删除 / 更新 (与`RESTRICT`一致)
- **`RESTRICT`** (默认)
	- 当在父表中删除/更新对应记录时, 首先检查该记录是否有对应外键, 如果有则**不允许**删除 / 更新 (与`NO ACTION`一致)
- **`CASCADE`** (级联)
	- 当在父表中删除/更新对应记录时, 首先检查该记录是否有对应外键, 如果有, 则**也删除 / 更新**外键在子表中的记录
	- 如果将对应外键表中的id修改, 则子表中的外键字段也会进行相应修改
- **`SET NULL`** 
	- 当在父表中删除对应记录时, 首先检查该记录是否有对应外键, 如果有则**设置子表中该外键值为null** (这就要求该外键允许取null)
- **`SET DEFAULT`** 
	- 父表有变更时, 子表**将外键列设置成一个默认的值** (**InnoDB不支持**)

- 示例 : 添加级联外键约束
```mysql
ALTER TABLE emp 
ADD CONSTRAINT fk_emp_dept_id 
FOREIGN KEY (dept_id) REFERENCES dept(id) 
ON UPDATE CASCADE ON DELETE CASCADE;
```


### 简述

- 51单片机的定时器属于单片机内部资源, 其电路连接以及运转均在单片机内部完成
- 可以实现软件计时, 使程序每隔固定时间完成某项操作
- 替代长时间的Delay, 提高CPU运行效率与处理速度

**STC89C52定时器资源**
- 定时器个数 : 3个 ( T0, T1, T2 ) , T0和T1与传统51单片机兼容 , T2是**此型号**单片机增加的资源
- 注意 : 单片机中定时器资源与单片机型号有关 , 不同型号单片机可能有不同数量的定时器以及对定时器不同的操作方式 . 但一般来说 , T0和T1操作方式是所有51单片机共有的

**定时器原理**
- 定时器在单片机内部 , 根据时钟的输出信号 , 每隔1个时间单位, 计数单元的值就增加1 , 当计数器增加到设定好的值 时, 就会向中断系统发出中断申请 , 使程序跳转到中断服务函数中执行

### 定时器工作模式

- T0和T1均有4种工作模式
	- 模式0 : 13位定时器 / 计数器
	- 模式1 : 16位定时器 / 计数器 (常用)
	- 模式2 : 8位自动重装模式 (T1在模式3时无效)
	- 模式3 : 两个8位计数器

**工作模式1框图**
- TH和TL共计最大可存65535
- SYSclk : 系统时钟, 即晶振周期 , 本开发板上晶振为11.0592MHz
![[硬件/STC89C51/Inbox/Pasted image 20250413142321.png]]

### 定时器相关寄存器

- 寄存器是连接软硬件的媒介
- 单片机中, 寄存器就是一段特殊的RAM存储器
	- 一方面, 寄存器可以存储和读取数据
	- 另一方面, 每个寄存器后都连接了一根导线, 控制着电路的连接方式
- 寄存器相当于机器的"操作按钮"
- 不可位寻址的寄存器只能整体赋值, 可位寻址的可以为单个位赋值

**定时器寄存器**
- TCON中
	- TF (Timer Overflow Flag) : 定时器溢出时由硬件自动置1; 若开中断(ET = 1), 则TF置1会进入中断处理函数, 并由硬件自动清0 ( 或软件清0 )
	- TR (Timer Run Control) : 定时器运行控制位, 由软件设置或清0; 为1时定时器启动, 为0时定时器停止
	- IE (Interrupt Edge Flag) : 外部中断触发标志位; 若检测到对应外部中断的触发信号(下降沿或低电平, 取决于IT)时, 硬件自动置1; 进入中断处理程序后, 如果为边沿触发模式(IT = 1), 则由硬件自动清零; 若为电平触发模式(IT = 0), 则需要软件手动清零
	- IT (Interrupt Type Control) : 外部中断触发方式控制位, 软件设置; IT = 1, 为边沿触发(下降沿有效) , IT = 0, 为电平触发(低电平有效) 
- TMOD中 (不可位寻址)
	- GATE(门控位), 决定定时器启动是否受外部中断引脚(INT0 / INT1)影响; GATE = 0(默认), 只需要软件设置TR=1即可启动定时器; GATE = 1, 则需要同时设置TR与INT位为高电平, 用于精确测量外部信号脉宽 ( 如超声波测距 ) 的场景
	- C/T (模式选择位), 用来决定作为定时器(Counter)还是计数器(Timer) , 为0时为定时器模式(默认), 为1时为计数器模式(计数外部引脚的下降沿脉冲)
	- M0和M1: 工作模式选择位
		- M1M0 - 00 , 13位定时器/计数器
		- M1M0 - 01 , 16位定时器/计数器
		- M1M0 - 10 , 8位自动重装模式
		- M1M0 - 11 , 双8位独立定时器(仅限T0)
- 置TMOD时, 建议使用与或式置位法
![[硬件/STC89C51/Inbox/Pasted image 20250413153154.png]]
**中断寄存器**
- IE ( Interrupt Enable, 中断允许寄存器 ) 中
	- EA (Enable All) : 置1允许中断进行, 该位置1后, 其他位的置1能开中断, 否则中断不会打开
	- ES (Enable Serial) : 串行口中断允许位
	- ET (Enable Timer) : 定时器中断允许位
	- EX (Enable External) : 外部中断允许位
- IP, IPH, XICON 共同组成优先级系统
	- PT2与PT2H, PX1与PX1H, PX3与PX3H等 2位, 可以表示4个数字, 对应4个优先级
	- XICON中还有对于外部中断2和外部中断3的ENABLE等
![[硬件/STC89C51/Inbox/Pasted image 20250413153239.png]]

### 中断系统
- 中断系统是为使CPU具有对外界紧急事件的实时处理能力而设置的
- CPU总是最先响应优先级最高的中断请求
- 如果在低优先级中断处理时发生了高优先级中断事件, 那么CPU会优先处理高优先级事件, 处理完毕后回到原中断处理函数, 这个过程被称为中断嵌套

**中断资源**
- STC89C51共有8个中断, 分别是
	- 外部中断0、定时器0中断、外部中断1、定时器1中断、串口(UART)中断、定时器2中断、外部中断2、外部中断3
- 所有中断共有 4 个优先级
- 注意: 中断的资源和单片机的型号时关联在一起的, 不同的型号可能有不同的中断资源
- 通过在函数后加上关键字 `interrupt` + 中断号, 声明函数成为对应的中断函数

**中断流程**
![[硬件/STC89C51/Inbox/Pasted image 20250413151305.png]]

### 配置实例
```c
void Timer0_Init() {
	TF0 = 0;			// TF0清空, 防止计时器刚一开始就中断
	TMOD &= 0xF0;	// TMOD与或方式赋值
	TMOD |= 0x01;
	// 每隔1us计数+1
	// 共计可计时65535us = 65ms
	// 设置1ms溢出一次
	TH0 = (65535 - 1000) / 256;
	TL0 = (65535 - 1000) % 256;
	TR0 = 1;			// 计时器开始
	ET0 = 1;			// 使能计时器中断
	EA = 1;				// 开启所有中断
	PT0 = 0;			// 最低中断优先级
}
```

注: 对于TL, 实际上其值应该+1, 因为65535并不会溢出, 65536才会溢出

**自动生成定时器**
- 注意没有AUXR
![[硬件/STC89C51/Inbox/Pasted image 20250413175226.png]]


### intrins.h
- `_cror_(目标值, 移位距离)` - 返回循环右移后的数
- `_crol_(目标值, 移位距离)` - 返回循环左移后的数

